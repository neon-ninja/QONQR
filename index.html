<!DOCTYPE html>
<html>

<head>
    <title>QONQR zone map</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="https://qonqr.com/Images/favicon.ico/android-icon-192x192.png" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://rawcdn.githack.com/robertleeplummerjr/Leaflet.glify/466c3696d9f67b7833089c15317ae9b6d7e5a30f/dist/glify-browser.js"></script>
    <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>
    <script src="https://unpkg.com/leaflet-search@2.9.8/dist/leaflet-search.src.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.8/src/leaflet-search.css" />
    <script src="https://nuclearsecrecy.github.io/Leaflet.greatCircle/Leaflet.greatCircle.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-164777450-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-164777450-1');
    </script>

    <style>
        body,
        html,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .legend {
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }

        .uncaptured {
            color: orange;
        }

        .legion {
            color: red;
        }

        .swarm {
            color: green;
        }

        .faceless {
            color: purple;
        }

        .uncapturedBG {
            background-color: orange;
        }

        .legionBG {
            background-color: red;
        }

        .swarmBG {
            background-color: green;
        }

        .facelessBG {
            background-color: purple;
        }

        .link {
            text-decoration: underline;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <div id="map"></div>
    <script>

        const zoneControlState = {
            0: "uncaptured",
            1: "legion",
            2: "swarm",
            3: "faceless"
        }

        const colours = {
            0: { r: 1, g: 0.647, b: 0 },
            1: { r: 1, g: 0, b: 0 },
            2: { r: 0, g: 1, b: 0 },
            3: { r: 0.5, g: 0, b: 0.5 }
        }

        var map = L.map('map', {
            center: [15, 30],
            zoom: 3,
            maxBounds: [[-90, -360], [90, 360]],
            worldCopyJump: true
        });

        var sql = `SELECT CONCAT(z.Description, ",", r.Description, ",", c.Description) AS Description, Latitude, Longitude FROM zones z
            INNER JOIN countries c ON z.countryid=c.countryid
            INNER JOIN regions r ON z.regionid=r.regionid
            WHERE MATCH (z.DESCRIPTION) AGAINST ("{s}") OR z.ZoneId="{s}"
        `;

        const API_BASE_URL = "https://api-proxy.auckland-cer.cloud.edu.au/QONQR/"
        const WSURL = "wss://api-proxy.auckland-cer.cloud.edu.au/QONQR/websocket"

        var search = L.control.search({
            url: API_BASE_URL + sql,
            formatData: function (data) {
                var lookup = [];
                for (var zone of data.results) {
                    lookup[zone.Description] = [zone.Latitude, zone.Longitude]
                }
                return lookup;
            },
            marker: L.circleMarker([0,0], {color: "DeepSkyBlue", fillOpacity: 0})
        });
        map.addControl(search);

        map.locate({
            setView: true,
            maxZoom: 5
        }).on("locationfound", function (e) {
            L.circle([e.latitude, e.longitude], { color: "cyan", radius: e.accuracy }).bindTooltip("You").addTo(map);
            var range_km = 1609.34;
            if (new Date().getUTCDay() == 1) { // Monday
                var week = Math.floor(new Date().getUTCDate() / 7);
                if (week == 1) {
                    range_km = 4828.032;
                } else if (week == 2) {
                    range_km = 9656.064;
                } else if (week >= 3) {
                    range_km = 20116.8;
                }
            }
            L.greatCircle([e.latitude, e.longitude], { color: "cyan", fillOpacity: 0, weight: .5, radius: range_km * 1000, interactive: false }).addTo(map);
        });

        var baseMaps = {
            "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
            "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
            "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron'),
            "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter").addTo(map),
            "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
            "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }),
            "Wikimedia": L.tileLayer.provider("Wikimedia")
        }

        var uncaptured = L.layerGroup().addTo(map);
        var legion = L.layerGroup().addTo(map);
        var swarm = L.layerGroup().addTo(map);
        var faceless = L.layerGroup().addTo(map);

        map.createPane('labels');
        map.getPane('labels').style.zIndex = 625;
        map.getPane('labels').style.pointerEvents = 'none';
        var labels = L.tileLayer.provider("Stamen.TonerLabels", {
            pane: "labels",
            interactive: false,
            opacity: .8,
        });

        map.createPane('whitelabels');
        map.getPane('whitelabels').style.zIndex = 625;
        map.getPane('whitelabels').style.pointerEvents = 'none';
        map.getPane('whitelabels').style.filter = 'invert(100%)';
        var whitelabels = L.tileLayer.provider("Stamen.TonerLabels", {
            pane: "whitelabels",
            interactive: false,
            opacity: .8,
        });

        var overlays = {
            "Uncaptured": uncaptured,
            "Legion": legion,
            "Swarm": swarm,
            "Faceless": faceless,
            "City labels": labels,
            "City labels (white)": whitelabels,
        }

        L.control.layers(baseMaps, overlays).addTo(map);

        var layers = Object.keys(overlays).slice(0,4);
        console.log(layers);

        window.teamfilter = [0, 1, 2, 3];
        map.on("overlayadd", function (e) {
            if (!window.data) return;
            layers.push(e.name);
            var indices = layers.map(e => Object.keys(overlays).indexOf(e));
            window.teamfilter = indices;
            updateURL();
            query();
        }).on("overlayremove", function (e) {
            if (!window.data) return;
            layers.splice(layers.indexOf(e.name), 1);
            var indices = layers.map(e => Object.keys(overlays).indexOf(e));
            window.teamfilter = indices;
            updateURL();
            query();
        });


        function clamp(num) {
            var min = 10;
            var max = 50;
            return num <= min ? min : num >= max ? max : num;
        }

        function formatDelta(delta) {
            if (!delta) {
                return "";
            } else if (delta >= 0) {
                delta = "+" + delta.toLocaleString();
            }
            return " (" + delta.toLocaleString() + ")";
        }

        function buildDescString(d) {
            var className = zoneControlState[d.ZoneControlState]
            var desc = "<b class='" + className + "'>" + d.Description + "</b>" +
                "<br>Zone ID: " + d.ZoneId +
                "<br>Captured: " + d.DateCapturedUtc.slice(0, 19) +
                "<br>Last updated: " + d.LastUpdateDateUtc.slice(0, 19) +
                "<div class='legion'>Legion: " + d.LegionCount.toLocaleString() + formatDelta(d.LegionDelta) +
                "</div><div class='swarm'>Swarm: " + d.SwarmCount.toLocaleString() + formatDelta(d.SwarmDelta) +
                "</div><div class='faceless'>Faceless: " + d.FacelessCount.toLocaleString() + formatDelta(d.FacelessDelta) + "</div>";
            return desc;
        }

        function createPointsLayer() {
            console.log(window.data.length);
            var points = data.map(e => [e.Latitude, e.Longitude]);
            if (window.pointsLayer) window.pointsLayer.remove()
            window.pointsLayer = L.glify.points({
                map: map,
                size: function (i, e) {
                    return clamp(data[i].TotalCount / 1E6);
                },
                color: function (i, e) {
                    return colours[data[i].ZoneControlState]
                },
                click: function (e, feature) {
                    var i = points.indexOf(feature);
                    sql = "SELECT ZoneId,Description,ZoneControlState,DateCapturedUtc,LegionCount,SwarmCount,FacelessCount,LastUpdateDateUtc,Latitude,Longitude,LegionDelta,SwarmDelta,FacelessDelta,TotalCount,TotalDelta FROM zones WHERE zoneId=" + data[i].ZoneId;
                    $.getJSON(API_BASE_URL + sql, function(data) {
                        console.log(data);
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(buildDescString(data.results[0]))
                            .openOn(map);
                    })
                },
                data: points,
                opacity: 1,
                //fragmentShaderSource: L.glify.shader.fragment.simpleCircle
            });
        }

        function updateStats(data) {
            var totalLegion = 0, totalSwarm = 0, totalFaceless = 0;
            for (var d of data) {
                totalLegion += d.LegionCount;
                totalSwarm += d.SwarmCount;
                totalFaceless += d.FacelessCount;
            }
            $("#stats").html("<div class='legion'>Total Legion bots:" + totalLegion.toLocaleString() +
                "</div><div class='swarm'>Total Swarm bots: " + totalSwarm.toLocaleString() +
                "</div><div class='faceless'>Total Faceless bots: " + totalFaceless.toLocaleString() +
                "</div><div>Total zones: " + data.length.toLocaleString() + "</div><div id='top10'>Top 10 zones:</div>");
            var sorted_data = data.filter(e => e.TotalDelta != undefined).sort((a, b) => a.TotalDelta < b.TotalDelta ? 1 : -1);
            var top10 = sorted_data.slice(0, 10);
            for (var i in top10) {
                var d = top10[i];
                var className = zoneControlState[d.ZoneControlState];
                $("#top10").append("<div onclick='map.flyTo([" + d.Latitude + "," + d.Longitude + "], 12)' class='link " +
                    className + "'>" + d.Description + ", " + region + ", " + country + "</div>")
            }
        }

        function getBoundsQueryFragment() {
            var bounds = map.getBounds()
            return `Latitude BETWEEN ${bounds.getSouth()} AND ${bounds.getNorth()} AND Longitude BETWEEN ${bounds.getWest()} AND ${bounds.getEast()}`
        }

        function getCountQueryFragment() {
            if (window.countfilter == "contested") {
                // Uncaptured zones are by definition uncontested
                // A Legion held zone, where the total bot count is not equal to the legion bot count, is contested
                return `IF (ZoneControlState = 1 AND TotalCount != LegionCount OR
                            ZoneControlState = 2 AND TotalCount != SwarmCount OR
                            ZoneControlState = 3 AND TotalCount != FacelessCount
                        , 1, 0)`;
            } else if (window.countfilter == "colocated") {
                return `Colocated = 1`
            } else {
                return `TotalCount >= ${window.countfilter}`
            }
        }

        function getTimeQueryFragment() {
            if (window.timefilter != "all") {
                if (window.timefilter.charAt(0) == ">") {
                    return `LastUpdateDateUtc < date_sub(UTC_DATE(), interval ${window.timefilter.slice(1)})`
                } else {
                    return `LastUpdateDateUtc > date_sub(UTC_DATE(), interval ${window.timefilter})`
                }
            } else {
                return 1
            }
        }

        function getTeamFilterQueryFragment() {
            return `ZoneControlState IN (${window.teamfilter.join(",")})`
        }

        window.limit = 100000

        function query() {
            if (!ws.readyState) return;
            if (window.pending) return;
            window.pending = true;
            map.spin(true, {color: "white"});
            var sql = `SELECT ZoneId,ZoneControlState,Latitude,Longitude,TotalCount
                        FROM zones
                        WHERE ${getBoundsQueryFragment()}
                        AND ${getCountQueryFragment()}
                        AND ${getTimeQueryFragment()}
                        AND ${getTeamFilterQueryFragment()}
                        ORDER BY TotalCount DESC
                        LIMIT ${limit}`;
            console.log(sql);
            ws.send(sql)
        }

        window.ws = new WebSocket(WSURL);
        window.pending = false;
        ws.onopen = function() {
            query();
        }
        ws.onmessage = function (evt) {
            window.pending = false;
            map.spin(false);
            var data = JSON.parse(evt.data);
            if (data.results.error) {
                console.error(data.results.error)
            }
            console.log(data.results);
            if (data.results.length == limit) {
                $("#max_zone_warning").show()
            } else {
                $("#max_zone_warning").hide()
            }
            window.data = data.results;
            // Check colocation
            var pointLookup = {}
            for (var d of window.data) {
                var p = [d.Latitude, d.Longitude]
                if (!pointLookup[p]) {
                    pointLookup[p] = [d];
                } else {
                    d.Longitude += .001 * pointLookup[p].length;
                    pointLookup[p].push(d);
                    for (var zone of pointLookup[p]) {
                        zone.colocated = true;
                    }
                }
            }
            createPointsLayer()
        }
        map.on('moveend', function(e) {
            query();
        });

        var legend = L.control({ position: 'bottomright' });

        function statsToggle() {
            $("#stats").toggle();
        }

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += `Shows zones with activity <select id="filtertime">
                    <option value="all">All time</option>
                    <option value=">6 year">more than 6 years ago</option>
                    <option value=">5 year">more than 5 years ago</option>
                    <option value=">4 year">more than 4 years ago</option>
                    <option value=">3 year">more than 3 years ago</option>
                    <option value=">2 year">more than 2 years ago</option>
                    <option value=">1 year">more than 1 year ago</option>
                    <option value="2 year">in the past 2 years</option>
                    <option value="1 year">in the past year</option>
                    <option value="1 month">in the past month</option>
                    <option value="1 week">in the past week</option>
                    <option value="1 day" selected>in the past day</option>
                </select><br>
                <select id='filter'>
                    <option value=0>Show all zones</option>
                    <option value=5000>Show zones > 5K</option>
                    <option value=1e4>Show zones > 10K</option>
                    <option value=1e5>Show zones > 100K</option>
                    <option value=1e6>Show zones > 1M</option>
                    <option value=1e7>Show zones > 10M</option>
                    <option value=1e8>Show zones > 100M</option>
                    <option value=contested>Show contested zones</option>
                    <option value=colocated>Show colocated zones</option>
                </select><br>
                <!--<a id='statsButton' class='link' onclick='statsToggle()'>Show/hide stats</a><div id='stats' style='display:none'></div>-->
                <div id="max_zone_warning" style="display:none">Warning: Limit of 100K zones shown. Zoom in to see more</div>
                <a href='https://github.com/neon-ninja/QONQR'>GitHub</a>`;
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        legend.addTo(map);
        window.countfilter = 0;
        window.timefilter = "1 day";

        var urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get("filter")) {
            window.countfilter = urlParams.get("filter");
            $("#filter").val(window.countfilter);
        }

        if (urlParams.get("timefilter")) {
            window.timefilter = urlParams.get("timefilter");
            $("#filtertime").val(window.timefilter);
        }

        if (urlParams.get("teamfilter")) {
            layers = urlParams.get("teamfilter").split(",")
            window.teamfilter = layers.map(e => Object.keys(overlays).indexOf(e));
            for (var l of Object.keys(overlays)) {
                if (layers.includes(l)) {
                    overlays[l].addTo(map);
                } else {
                    overlays[l].removeFrom(map);
                }
            }
            console.log(window.teamfilter)
        }

        function updateURL() {
            urlParams.set("filter", window.countfilter);
            urlParams.set("timefilter", window.timefilter);
            urlParams.set("teamfilter", layers);
            var newRelativePathQuery = window.location.pathname + '?' + urlParams.toString();
            history.pushState(null, '', newRelativePathQuery);
        }

        $("#filter").change(function () {
            window.countfilter = this.value;
            query();
            updateURL();
        })

        $("#filtertime").change(function () {
            window.timefilter = this.value;
            query();
            updateURL();
        })

    </script>

</body>

</html>
